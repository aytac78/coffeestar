<script>
  // --- SUPABASE AYARLARI ---
  const supabaseUrl = 'https://giurtvcbubdkjrvfjdtc.supabase.co';
  const supabaseKey =
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdpdXJ0dmNidWJka2pydmZqZHRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzE3OTcyMDAsImV4cCI6MjA0NzM3MzIwMH0._YsmW3YV_6Q6c4QbQZGYBtsBv88s3W0S5tRcIP_bZ5Y';

  const { createClient } = window.supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  // --- STATE & DOM ---

  // Supabase'ten gelen verileri burada tutacaÄŸÄ±z
  let venues = [];

  const venueList = document.getElementById('venueList');
  const filterButtons = document.querySelectorAll('.filter-pill');
  const distanceNote = document.getElementById('distanceNote');
  const modeButtons = document.querySelectorAll('.mode-btn');
  const customerPanel = document.getElementById('customerPanel');
  const businessPanel = document.getElementById('businessPanel');
  const bizForm = document.getElementById('businessForm');
  const bizList = document.getElementById('bizList');

  let activeDistrict = 'all';

  // --- SUPABASE --> JS FORMAT Ã‡EVÄ°RÄ°CÄ° ---

  function mapRowToVenue(row) {
    return {
      id: row.id,
      name: row.name,
      district: row.district || 'Bodrum Merkez',
      rating: typeof row.rating === 'number' ? row.rating : 0,
      votes: typeof row.votes === 'number' ? row.votes : 0,
      priceLevel:
        row.pricelevel ??
        row.price_level ??
        row.price ??
        2, // kolon ismi farklarÄ±na tolerans
      tags: row.tags ?? [],
      notes: row.notes || row.description || '',
      wifi: row.wifi || '',
      approxDistance: row.approx_distance ?? row.distance_km ?? 0
    };
  }

  // --- RENDER FONKSÄ°YONU ---

  function renderVenues(dataOverride) {
    const data = dataOverride || venues;

    if (!venueList) return;

    // Filtre: aktif bÃ¶lge
    let filtered = data;
    if (activeDistrict !== 'all') {
      filtered = data.filter(v => v.district === activeDistrict);
    }

    venueList.innerHTML = '';

    filtered.forEach(v => {
      const card = document.createElement('div');
      card.className = 'venue-card';

      const header = document.createElement('div');
      header.className = 'venue-card-header';

      const h3 = document.createElement('h3');
      h3.textContent = v.name;

      const info = document.createElement('div');
      info.className = 'venue-info';
      info.textContent = v.district || '';

      header.appendChild(h3);
      header.appendChild(info);

      const body = document.createElement('div');
      body.className = 'venue-card-body';

      const p = document.createElement('p');
      p.textContent = v.notes || '';
      body.appendChild(p);

      const footer = document.createElement('div');
      footer.className = 'venue-card-footer';

      const btnRow = document.createElement('div');
      btnRow.className = 'btn-row';

      const btnDetail = document.createElement('button');
      btnDetail.className = 'btn-sm';
      btnDetail.textContent = 'Detay / Yorum';
      btnDetail.onclick = () => {
        alert(
          `${v.name}\n\nPuan: ${v.rating?.toFixed?.(1) || '0.0'} (${v.votes} oy)\n` +
            `BÃ¶lge: ${v.district}\n` +
            `Fiyat: ${'â˜•'.repeat(v.priceLevel || 1)}\n\n` +
            `Not: ${v.notes || '-'}`
        );
      };

      const btnRate = document.createElement('button');
      btnRate.className = 'btn-sm primary';
      btnRate.textContent = 'Puan Ver';
      btnRate.onclick = () => {
        alert(
          `${v.name} iÃ§in puan verme ekranÄ± (demo).\n\nGerÃ§ek sistemde kullanÄ±cÄ± login + rating / yorum akÄ±ÅŸÄ± aÃ§Ä±lacak.`
        );
      };

      btnRow.appendChild(btnDetail);
      btnRow.appendChild(btnRate);
      footer.appendChild(btnRow);

      card.appendChild(header);
      card.appendChild(body);
      card.appendChild(footer);

      venueList.appendChild(card);
    });
  }

  // --- SUPABASE'TEN VERÄ° Ã‡EKME ---

  async function loadVenues() {
    try {
      const { data, error } = await supabaseClient.from('venues').select('*');

      if (error) {
        console.error('Supabase error:', error);
        return;
      }

      console.log('Supabase Data:', data);

      venues = (data || []).map(mapRowToVenue);
      renderVenues(); // ilk Ã§izim
    } catch (err) {
      console.error('loadVenues exception:', err);
    }
  }

  // --- FÄ°LTRE BUTONLARI ---

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeDistrict = btn.dataset.district || 'all';
      renderVenues();
    });
  });

  // --- MOD (MÃœÅTERÄ° / Ä°ÅLETME) BUTONLARI ---

  modeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      modeButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const mode = btn.dataset.mode;
      if (mode === 'customer') {
        customerPanel.classList.add('active');
        businessPanel.classList.remove('active');
      } else {
        customerPanel.classList.remove('active');
        businessPanel.classList.add('active');
      }
    });
  });

  // --- DEMO Ä°ÅLETME BAÅVURU FORMU (mevcut kodlarÄ±n korunmasÄ± iÃ§in basit placeholder) ---

  if (bizForm) {
    bizForm.addEventListener('submit', e => {
      e.preventDefault();
      alert(
        'Demo sÃ¼rÃ¼m: Ä°ÅŸletme baÅŸvurunuz alÄ±ndÄ± gibi davranÄ±yoruz ğŸ˜Š\nGerÃ§ek sistemde bu form Supabaseâ€™e kaydedilecek.'
      );
      bizForm.reset();
    });
  }

  // --- GEOLOCATION NOTU (mevcut metni koruyoruz) ---

  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      () => {
        distanceNote.textContent =
          'ğŸ“ Konum izni aktif. Bu demo sÃ¼rÃ¼mde yaklaÅŸÄ±k mesafe sabit, gerÃ§ek sistemde gerÃ§ek lokasyona gÃ¶re sÄ±ralanacaktÄ±r.';
      },
      () => {
        distanceNote.textContent =
          'ğŸ“ Konum izni verilmedi. Bodrum mekanlarÄ± yaklaÅŸÄ±k mesafeye gÃ¶re listeleniyor.';
      }
    );
  } else {
    distanceNote.textContent =
      'ğŸ“ TarayÄ±cÄ±nÄ±z konum desteÄŸi sunmuyor. Bodrum mekanlarÄ± yaklaÅŸÄ±k mesafeye gÃ¶re listeleniyor.';
  }

  // --- INIT ---

  loadVenues();
</script>
  // --- SUPABASE AYARLARI ---

  const supabaseUrl = 'SUPABASE_URLÄ°N';         // Ã–rn: https://xxxxx.supabase.co
  const supabaseKey = 'SUPABASE_ANON_KEYÄ°N';    // Supabase anon public key

  const { createClient } = window.supabase;
  const supabaseClient = createClient(supabaseUrl, supabaseKey);

  // --- STATE & DOM ---

  const venueList = document.getElementById('venueList');
  const filterButtons = document.querySelectorAll('.filter-pill');
  const distanceNote = document.getElementById('distanceNote');
  const modeButtons = document.querySelectorAll('.mode-btn');
  const customerPanel = document.getElementById('customerPanel');
  const businessPanel = document.getElementById('businessPanel');
  const bizForm = document.getElementById('businessForm');
  const bizList = document.getElementById('bizList');

  let activeDistrict = 'all';
  let venuesCache = [];

  // --- SUPABASE ROW â†’ FRONTEND NESNE ---

  function mapRowToVenue(row) {
    return {
      id: row.id,
      name: row.name,
      district: row.district || 'Bodrum Merkez',
      rating: typeof row.rating === 'number' ? row.rating : 0,
      votes: typeof row.votes === 'number' ? row.votes : 0,
      priceLevel:
        row.pricelevel ??
        row.price_level ??
        row.price ??
        2,
      tags: row.tags ?? [],
      notes: row.notes || row.description || '',
      wifi: row.wifi || '',
      approxDistance: row.approx_distance ?? row.distance_km ?? 0
    };
  }

  // --- KART Ã‡Ä°ZÄ°MÄ° ---

  function renderVenueCards(data) {
    if (!venueList) {
      console.error('venueList elementi bulunamadÄ±');
      return;
    }

    venueList.innerHTML = '';

    const filtered = data.filter(v => {
      if (activeDistrict === 'all') return true;
      return (v.district || '').toLowerCase() === activeDistrict.toLowerCase();
    });

    if (filtered.length === 0) {
      venueList.innerHTML = '<p>Bu bÃ¶lge iÃ§in henÃ¼z kayÄ±tlÄ± kahve mekanÄ± yok.</p>';
      return;
    }

    filtered.forEach(v => {
      const card = document.createElement('div');
      card.className = 'card';

      const headerRow = document.createElement('div');
      headerRow.className = 'card-header-row';

      const left = document.createElement('div');
      left.className = 'card-header-left';

      const nameEl = document.createElement('h3');
      nameEl.textContent = v.name;
      left.appendChild(nameEl);

      const districtEl = document.createElement('div');
      districtEl.className = 'meta';
      districtEl.textContent = v.district || '';
      left.appendChild(districtEl);

      const distanceEl = document.createElement('div');
      distanceEl.className = 'meta';
      if (v.approxDistance) {
        distanceEl.textContent = `~${v.approxDistance.toFixed(1)} km tahmini mesafe`;
      }
      left.appendChild(distanceEl);

      const right = document.createElement('div');
      right.className = 'card-header-right';
      right.textContent = `${v.rating.toFixed(1)}  â€¢  ${v.votes} oy`;

      headerRow.appendChild(left);
      headerRow.appendChild(right);

      const body = document.createElement('div');
      body.className = 'card-body';

      if (v.notes) {
        const notesEl = document.createElement('p');
        notesEl.textContent = v.notes;
        body.appendChild(notesEl);
      }

      if (Array.isArray(v.tags) && v.tags.length > 0) {
        const tagsRow = document.createElement('div');
        tagsRow.className = 'tag-row';
        v.tags.forEach(tag => {
          const span = document.createElement('span');
          span.className = 'tag';
          span.textContent = tag;
          tagsRow.appendChild(span);
        });
        body.appendChild(tagsRow);
      }

      if (v.wifi) {
        const wifiEl = document.createElement('div');
        wifiEl.className = 'meta';
        wifiEl.textContent = v.wifi;
        body.appendChild(wifiEl);
      }

      const footer = document.createElement('div');
      footer.className = 'card-footer-row';

      const btnDetail = document.createElement('button');
      btnDetail.className = 'btn-sm';
      btnDetail.textContent = 'Detay / Yorum';
      btnDetail.onclick = () => {
        alert(
          `${v.name}\n\nPuan: ${v.rating.toFixed(1)} (${v.votes} oy)\nBÃ¶lge: ${v.district}\n\nNot: ${v.notes}`
        );
      };

      const btnRate = document.createElement('button');
      btnRate.className = 'btn-sm primary';
      btnRate.textContent = 'Puan Ver';
      btnRate.onclick = () => {
        alert(
          `${v.name} iÃ§in puan verme ekranÄ± (demo).\nGerÃ§ek sistemde kullanÄ±cÄ± login + rating / yorum akÄ±ÅŸÄ± aÃ§Ä±lacak.`
        );
      };

      footer.appendChild(btnDetail);
      footer.appendChild(btnRate);

      card.appendChild(headerRow);
      card.appendChild(body);
      card.appendChild(footer);

      venueList.appendChild(card);
    });
  }

  // --- SUPABASE'TEN VERÄ° Ã‡EK ---

  async function loadVenues() {
    try {
      const { data, error } = await supabaseClient.from('venues').select('*');
      if (error) {
        console.error('Supabase error:', error);
        renderVenueCards([]);
        return;
      }

      console.log('Supabase Data:', data);
      venuesCache = (data || []).map(mapRowToVenue);
      renderVenueCards(venuesCache);
    } catch (err) {
      console.error('Beklenmeyen hata:', err);
      renderVenueCards([]);
    }
  }

  // --- FÄ°LTRE BUTONLARI ---

  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      activeDistrict = btn.dataset.district || 'all';
      renderVenueCards(venuesCache);
    });
  });

  // --- MOD (MÃ¼ÅŸteri / Ä°ÅŸletme) BUTONLARI ---

  modeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      modeButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');

      const mode = btn.dataset.mode;
      if (mode === 'customer') {
        customerPanel.classList.add('active');
        businessPanel.classList.remove('active');
      } else {
        customerPanel.classList.remove('active');
        businessPanel.classList.add('active');
      }
    });
  });

  // --- GEOLOCATION BÄ°LGÄ° METNÄ° (mesafeyi hesaplamÄ±yoruz, sadece bilgilendirme) ---

  if ('geolocation' in navigator) {
    navigator.geolocation.getCurrentPosition(
      () => {
        distanceNote.textContent =
          'ğŸ“ Konum izni aktif. Bu demo sÃ¼rÃ¼mde yaklaÅŸÄ±k mesafe sabit, gerÃ§ek sistemde gerÃ§ek lokasyona gÃ¶re sÄ±ralanacaktÄ±r.';
      },
      () => {
        distanceNote.textContent =
          'ğŸ“ Konum izni verilmedi. Bodrum mekanlarÄ± yaklaÅŸÄ±k mesafeye gÃ¶re listeleniyor.';
      }
    );
  } else {
    distanceNote.textContent =
      'ğŸ“ TarayÄ±cÄ±nÄ±z konum desteÄŸi sunmuyor. Bodrum mekanlarÄ± yaklaÅŸÄ±k mesafeye gÃ¶re listeleniyor.';
  }

  // --- Ä°NÄ°T ---

  loadVenues();
</script>
